<!DOCTYPE html>
<html class="family-primary">

<head>
    <title>Find the perfect movie</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="css/bulma_custom/css/mystyles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <script src="js/smoothscroll/smoothscroll.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
</head>
<style>
    .movie-trailer {
        width: 100%;
        height: 30vh;
        object-fit: cover;
        -webkit-mask-image: -webkit-gradient(linear, left top, left bottom, from(rgba(0, 0, 0, 1)), to(rgba(0, 0, 0, 0)));
        mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0));
    }

    .movie-poster {
        max-height: 30vh;
        max-width: 30vh;
        border-radius: 5px;
    }

    .movie-title {
        color: white;
        font-size: 2em;
        font-weight: 600;
    }

    .movie-info {
        font-size: 1em;
        padding-top: 0.8em;
        color: #b3b3b3;
    }

    .movie-info p {
        padding-bottom: 0.8em;
    }

    .movie-boxed {
        border-radius: 2px;
        border: 1.5px solid #b3b3b3;
        padding-top: 1px;
        padding-bottom: 1px;
        padding-left: 2px;
        padding-right: 2px;
    }

    .movie-plot {
        border: 2px solid #b3b3b3;
        border-right: none;
        border-bottom: none;
        border-top: none;
        padding-left: 0.7em;
    }

    .actor-container {
        position: relative;
        display: inline-flex;
        justify-content: center;
        width: min-content;
    }

    .actor-name {
        position: absolute;
        bottom: 1em;
        padding: 0.3em;
        font-size: 0.8em;
        max-width: 80%;
        white-space: normal;
        word-wrap: break-word;
        background-color: black;
        color: white;
    }

    .actor-name p {
        text-align: center;
    }

    .scrollmenu {
        flex: auto !important;
        overflow: auto;
        white-space: nowrap;
        -ms-overflow-style: none;
        scrollbar-width: none;
        scroll-behavior: smooth;
    }

    .scrollmenu::-webkit-scrollbar {
        display: none;
    }

    .scrollmenu img {
        margin-left: 0.5em;
        margin-right: 0.5em;
        box-shadow: 1px 1px 12px 0px black;
    }

    .scrollarrows {
        display: flex;
        align-items: center;
        width: min-content;
    }

    .tilebox {
        background-color: #090979;
        border-radius: 10px;
        margin: 0.5em;
    }

    .moreinfo p {
        padding-bottom: 1em;
    }

    .close-overlay-button {
        position: fixed;
        top: 5%;
        left: 5%;
    }

    .watchlist-overlay {
        z-index: 25;
        overflow: hidden scroll;
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0px;
        left: 0px;
        right: 0px;
        bottom: 0px;
        background-color: black;
        cursor: pointer;
    }

    .buttons-group-mod {
        border: 1.5px solid;
        background-color: transparent;
        color: white;
    }

    @media (max-width: 768px) {

        /*mobile*/
        .movie-trailer {
            height: 20vh;
        }

        .movie-poster {
            max-height: 18vh;
            max-width: 18vh;
        }

        .movie-title {
            font-size: 1.5em;
        }

        .movie-info {
            font-size: 0.8em;
        }

        .actor-name {
            font-size: 0.5em;
            max-width: 10vh;
        }

        .scrollmenu {
            flex: initial;
        }

        .scrollmenu img {
            margin-right: 0.5em;
        }

        .scrollarrows {
            display: none;
        }
    }
</style>

<body>
    <section id="app" class="hero">
        <div class="hero-head">
            <div>
                <img class="movie-trailer" v-bind:src="movie.Poster" />
            </div>
        </div>
        <div class="hero-body" style="display: none;" v-show="!_.isEmpty(movie)">
            <div class="columns is-mobile is-centered is-multiline">
                <div class="column is-narrow">
                    <img class="movie-poster" v-bind:src="movie.Poster" />
                </div>
                <div class="column">
                    <h1 class="movie-title">
                        {{movie.Title}}
                        <!-- Those magnificent men and their flying machines, or how I flew from Londen to Paris in 23 hours 11 minutes -->
                    </h1>
                    <div class="movie-info">
                        <p>{{movie.Year}} &middot; {{movie.Runtime}} &middot; <span
                                class="movie-boxed">{{movie.Rated}}</span></p>
                        <p>IMDb {{movie.imdbRating}} &middot; {{movie.Genre}}</p>
                        <a id="watchlist"
                            onclick="WatchlistHandler(this, app.movie.imdbID, app.movie.Title, app.movie.Poster);"
                            class="button is-small is-hovered is-rounded is-outlined buttons-group-mod has-text-white">
                            <span v-show="showplus == false">
                                <i class="fas fa-check"></i>
                                &nbsp;
                                Watchlist
                                &nbsp;
                            </span>
                            <span v-show="showplus == true">
                                <i class="fas fa-plus"></i>
                                &nbsp;
                                Watchlist
                                &nbsp;
                            </span>
                        </a>
                    </div>
                </div>
                <div class="column is-12" style="height: 0 !important; width: 0 !important"></div>
                <div class="column is-10-desktop is-10-widescreen is-11-tablet is-12-mobile">
                    <p class="movie-plot">
                        <span style="font-variant: small-caps; font-weight: 600; color: #b3b3b3;">plot</span>
                        <br>
                        {{movie.Plot}}
                    </p>
                </div>

                <div class="similar column is-12 movie-title">
                    <p>Similar</p>
                </div>
                <div class="similar column is-narrow scrollarrows">
                    <i onclick="document.getElementById('similar').scrollBy({ top: 0, left: -300, behavior: 'smooth' });"
                        class="fas fa-arrow-left fa-2x" style="margin-right: 0.3em;">
                    </i>
                </div>
                <div id="similar" class="similar column is-10-desktop is-12-mobile scrollmenu">

                </div>
                <div class="similar column is-narrow scrollarrows">
                    <i onclick="document.getElementById('similar').scrollBy({ top: 0, left: 300, behavior: 'smooth' });"
                        class="fas fa-arrow-right fa-2x" style="margin-left: 0.3em;">
                    </i>
                </div>

                <div class="cast column is-12 movie-title">
                    <p>Cast</p>
                </div>
                <div class="cast column is-narrow scrollarrows">
                    <i onclick="document.getElementById('cast').scrollBy({ top: 0, left: -300, behavior: 'smooth' });"
                        class="fas fa-arrow-left fa-2x" style="margin-right: 0.3em;">
                    </i>
                </div>
                <div id="cast" class="cast column is-10-desktop is-12-mobile scrollmenu">
                </div>
                <div class="cast column is-narrow scrollarrows">
                    <i onclick="document.getElementById('cast').scrollBy({ top: 0, left: 300, behavior: 'smooth' });"
                        class="fas fa-arrow-right fa-2x" style="margin-left: 0.3em;">
                    </i>
                </div>

                <div class="writers column is-12 movie-title">
                    <p>Writer(s)</p>
                </div>
                <div class="writers column is-narrow scrollarrows">
                    <i onclick="document.getElementById('writers').scrollBy({ top: 0, left: -300, behavior: 'smooth' });"
                        class="fas fa-arrow-left fa-2x" style="margin-right: 0.3em;">
                    </i>
                </div>
                <div id="writers" class="writers column is-10-desktop is-12-mobile scrollmenu">
                </div>
                <div class="writers column is-narrow scrollarrows">
                    <i onclick="document.getElementById('writers').scrollBy({ top: 0, left: 300, behavior: 'smooth' });"
                        class="fas fa-arrow-right fa-2x" style="margin-left: 0.3em;">
                    </i>
                </div>

                <div class="column is-12 movie-title">
                    <p>Details</p>
                </div>

                <div class="column is-11-desktop is-12-mobile">
                    <div class="tile is-ancestor">
                        <div class="tile is-vertical is-parent is-4 tilebox">
                            <div class="tile is-child">
                                <p class="subtitle">Director</p>
                                <div style="display: flex;">
                                    <div style="margin-right: 1em;">
                                        <div class="actor-container">
                                            <img id="directorposter" class="movie-poster">
                                            <div class="actor-name">
                                                <p>{{movie.Director}}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <p style="font-weight: 600; padding-bottom: 0.3em;">Known for</p>
                                        <p id="knownfor">
                                            This director wasn't known for anything.
                                        </p>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="tile is-vertical is-parent tilebox">
                            <p class="subtitle">More info</p>
                            <div class="tile moreinfo">
                                <div class="tile is-child">
                                    <p style="font-weight: 600">General Info</p>
                                    <p>Released: {{movie.Released}}</p>
                                    <p>Language(s): {{movie.Language}}</p>
                                    <p>Country: {{movie.Country}}</p>
                                    <p>Awards: {{movie.Awards}} </p>
                                </div>
                                <div class="tile is-child">
                                    <p style="font-weight: 600">Ratings</p>
                                    <div v-for="rating in movie.Ratings">
                                        <p>{{rating.Source}}: {{rating.Value}}</p>
                                    </div>
                                </div>
                                <div class="tile is-child">
                                    <p style="font-weight: 600">Details</p>
                                    <p>BoxOffice: {{movie.BoxOffice}}</p>
                                    <p>Production: {{movie.Production}}</p>
                                    <p>Website: {{movie.Website}}</p>
                                    <p>IMDb ID: {{movie.imdbID}}</p>

                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div id="watchlist-overlay-container-backbutton" style="position: absolute; top: 5%; right: 5%">
        <a onclick="OpenWatchlist()" class="button is-rounded is-primary"><i class="fas fa-stream"></i>
            &nbsp; Watchlist</a>
    </div>

    <div style="z-index:26; display: none;" id="watchlist-overlay-container-backbutton" class="close-overlay-button">
        <i onclick="CloseWatchlist()" class="fas fa-arrow-left fa-2x"></i>
    </div>
    <div style="display: none;" class="watchlist-overlay" id="watchlist-overlay-container">
        <div class="container is-fluid" style="padding-top:7%;">
            <div class="columns is-multiline is-centered">
                <div class="column is-11">
                    <p style="font-size: 200%">
                        <i class="fas fa-stream"></i> &nbsp;
                        Your Watchlist
                    </p>
                    <p class="subtitle" style="font-variant: small-caps">
                        hover over the posters for more options
                    </p>
                </div>
                <div class="column is-12">
                    <div>
                        <div class="column is-12">
                            <div class="tile is-ancestor">
                                <div id="watchlist-overlay" class="tile is-parent is-12" style="flex-wrap: wrap;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: none;" id="watchlist-overlay-empty-msg" class="column is-8; has-text-centered">
                    <p style='font-size:200%'>Your watchlist is empty :(</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        var app = new Vue({
            el: "#app",
            data: {
                //movie: { "Title": "Joker", "Year": "2019", "Rated": "R", "Released": "04 Oct 2019", "Runtime": "122 min", "Genre": "Crime, Drama, Thriller", "Director": "Todd Phillips", "Writer": "Todd Phillips, Scott Silver, Bob Kane (based on characters created by), Bill Finger (based on characters created by), Jerry Robinson (based on characters created by)", "Actors": "Joaquin Phoenix, Robert De Niro, Zazie Beetz, Frances Conroy", "Plot": "In Gotham City, mentally-troubled comedian Arthur Fleck is disregarded and mistreated by society. He then embarks on a downward spiral of revolution and bloody crime. This path brings him face-to-face with his alter-ego: \"The Joker\".", "Language": "English", "Country": "USA, Canada", "Awards": "N/A", "Poster": "https://m.media-amazon.com/images/M/MV5BNGVjNWI4ZGUtNzE0MS00YTJmLWE0ZDctN2ZiYTk2YmI3NTYyXkEyXkFqcGdeQXVyMTkxNjUyNQ@@._V1_SX300.jpg", "Ratings": [{ "Source": "Internet Movie Database", "Value": "8.9/10" }, { "Source": "Rotten Tomatoes", "Value": "68%" }, { "Source": "Metacritic", "Value": "59/100" }], "Metascore": "59", "imdbRating": "8.9", "imdbVotes": "360,218", "imdbID": "tt7286456", "Type": "movie", "DVD": "N/A", "BoxOffice": "N/A", "Production": "Warner Bros. Pictures", "Website": "N/A", "Response": "True" }
                movie: {},
                showplus: true
            }
        });

        function parseQuery(queryString) {
            var query = {};
            var pairs = (queryString[0] === '?' ? queryString.substr(1) : queryString).split('&');
            for (var i = 0; i < pairs.length; i++) {
                var pair = pairs[i].split('=');
                query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
            }
            return query;
        }

        async function LoadJSON() {
            const query = window.location.search;
            const parsed = parseQuery(query);
            const id = parsed.id;

            fetch("db/ind/" + id + ".json")
                .then(res => {
                    if (!res.ok) {
                        throw new Error("Failed with HTTP code " + response.status);
                    }
                    return res.json()
                })
                .then(json => {
                    app.movie = json;
                    if (app.movie.Poster == "N/A") { app.movie.Poster = "images/unknown.png" }
                    LoadImages();
                })
                .catch(err => {
                    console.log("Error: " + err);
                })

        }

        async function LoadImages() {
            var similarurl = "https://api.themoviedb.org/3/movie/" + app.movie.imdbID + "/similar?api_key=8ca85a295652c75508670fd4aa6907ce&language=en-US&page=1";
            fetch(similarurl)
                .then(res => {
                    if (!res.ok) {
                        throw new Error("Failed with HTTP code " + response.status);
                    }
                    return res.json()
                })
                .then(json => {
                    var similar = document.getElementById("similar");
                    similar.innerHTML = ""
                    if (json.total_results == 0) {
                        similar.style.display = "none";
                        for (el of document.getElementsByClassName("similar")) { el.style.display = "none" }
                    }
                    else {
                        json.results.forEach(movie => {
                            var m = `<div class="actor-container">
                        <img class="movie-poster" src="` + verifyImg(movie.poster_path) + `">
                        <div class="actor-name">
                            <p>` + movie.title + `</p>
                        </div>
                    </div>`
                            similar.insertAdjacentHTML("beforeend", m);
                        });
                    }
                })
                .catch(err => {
                    console.log("Error: " + err);
                })

            if (app.movie.Actors != "N/A") {
                var casturl = "https://api.themoviedb.org/3/movie/" + app.movie.imdbID + "/credits?api_key=8ca85a295652c75508670fd4aa6907ce";
                fetch(casturl)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error("Failed with HTTP code " + response.status);
                        }
                        return res.json()
                    })
                    .then(json => {
                        var cast = document.getElementById("cast");
                        cast.innerHTML = ""
                        json.cast.forEach(person => {
                            var m = `<div class="actor-container">
                        <img class="movie-poster" src="` + verifyImg(person.profile_path) + `">
                        <div class="actor-name">
                            <p>` + person.name + `</p>
                        </div>
                    </div>`
                            cast.insertAdjacentHTML("beforeend", m);
                        });
                    })
                    .catch(err => {
                        console.log("Error: " + err);
                    })
            }
            else {
                document.getElementById("cast").style.display = "none";
                for (el of document.getElementsByClassName("cast")) { el.style.display = "none" }
            }

            var writers = document.getElementById("writers");
            writers.innerHTML = "";
            if (app.movie.Writer != "N/A") {
                app.movie.Writer.split(", ").forEach(person => {
                    writer = person.replace(/ *\([^)]*\) */g, "");
                    var writerurl = "https://api.themoviedb.org/3/search/person?query=" + writer + "&api_key=8ca85a295652c75508670fd4aa6907ce&language=en-US&page=1&include_adult=false";
                    fetch(writerurl)
                        .then(res => {
                            if (!res.ok) {
                                throw new Error("Failed with HTTP code " + response.status);
                            }
                            return res.json()
                        })
                        .then(json => {
                            var info = json.results[0];
                            var m = `<div class="actor-container">
                        <img class="movie-poster" src="` + verifyImg(info.profile_path) + `">
                        <div class="actor-name">
                            <p>` + info.name + `</p>
                        </div>
                    </div>`
                            writers.insertAdjacentHTML("beforeend", m);
                        })
                        .catch(err => {
                            console.log("Error: " + err);
                        })
                });
            }
            else {
                writers.style.display = "none";
                for (el of document.getElementsByClassName("writers")) { el.style.display = "none" }
            }

            if (app.movie.Director != "N/A") {
                var directorurl = "https://api.themoviedb.org/3/search/person?api_key=8ca85a295652c75508670fd4aa6907ce&language=en-US&query=" + app.movie.Director + "&page=1&include_adult=false";
                fetch(directorurl)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error("Failed with HTTP code " + response.status);
                        }
                        return res.json()
                    })
                    .then(json => {
                        document.getElementById("directorposter").setAttribute("src", verifyImg(json.results[0].profile_path));
                        var known_for = document.createElement("ul");
                        json.results[0].known_for.forEach(movie => {
                            var child = document.createElement("li");
                            child.innerText = movie.title;
                            known_for.appendChild(child);
                        });

                        var known_for_container = document.getElementById("knownfor");
                        known_for_container.innerHTML = "";
                        known_for_container.appendChild(known_for);
                    })
                    .catch(err => {
                        console.log("Error: " + err);
                    })
            }
            else {
                document.getElementById("directorposter").setAttribute("src", verifyImg(null));
                app.movie.Director = "Unknown";
            }
        }

        function verifyImg(img) {
            if (img == null) {
                return "images/unknown.png"
            }
            return "https://image.tmdb.org/t/p/w185/" + img;
        }

        function WatchlistHandler(elem, id, title = "", poster = "") {
            var classes = elem.classList;
            var toggler = "is-link";
            if (!classes.contains(toggler)) { //add
                classes.add(toggler);
                app.showplus = false;
                SaveToWatchlist(id, title, poster);
            }
            else { //remove
                classes.remove(toggler);
                app.showplus = true;
                RemoveFromWatchlist(id);
            }
        }

        function OpenWatchlist() {
            console.log("Opening Watchlist...")
            let list = localStorage.getItem("Watchlist");
            //let list = overlay.twentypopularmovies;
            var watchlist_container = document.getElementById('watchlist-overlay');
            document.body.style.overflow = "hidden";
            if (list != null && list != "[]" && list != "") {
                document.getElementById('watchlist-overlay-container-backbutton').style.display = 'initial';
                document.getElementById('watchlist-overlay-container').style.display = 'initial';
                document.getElementById('watchlist-overlay-empty-msg').style.display = 'none';
                var watchlist_container = document.getElementById('watchlist-overlay');
                watchlist_container.innerHTML = "";
                for (movie of JSON.parse(list)) {
                    let imgurl = "images/unknown.png";
                    if (movie.Poster != "N/A" && movie.Poster != undefined && movie.Poster != null && movie.Poster != "") {
                        imgurl = movie.Poster;
                    }
                    var watchlist = `
                <div class="tile is-child is-2" id="watchlist-`+ movie.imdbID + `">
                    <div class="smallmovie">
                        <ul>
                            <div class="card-home">
                                <li>
                                    <div style="height: 13.5em;" class="imgbox">
                                        <img src="` + imgurl + `"
                                            class="movie-poster smallposter">
                                        <div class="middle">
                                            <ul>
                                                <li>
                                                    <a href="" class="button is-small is-primary is-rounded">Open &nbsp; <i class="fas fa-external-link-alt"></i></a>
                                                </li>
                                                <li>
                                                    <a onclick="RemoveElemFromWatchlistUI(this)" data-imdb-id="`+ movie.imdbID + `" class="button is-small is-primary is-rounded">Delete &nbsp; <i class="far fa-trash-alt"></i></a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <p class="caption">
                                        `+ movie.Title + `
                                    </p>                                               
                                </li>
                            </div>
                        </ul>
                    </div>
                </div>
            `;

                    watchlist_container.insertAdjacentHTML('beforeend', watchlist);
                }
            }
            else {
                document.getElementById('watchlist-overlay-container-backbutton').style.display = 'initial';
                document.getElementById('watchlist-overlay-container').style.display = 'initial';
                document.getElementById('watchlist-overlay-empty-msg').style.display = 'initial';
            }
        }

        function CloseWatchlist() {
            console.log("Closing Watchlist...");
            document.getElementById('watchlist-overlay-container-backbutton').style.display = 'none';
            document.getElementById('watchlist-overlay-container').style.display = 'none';
            document.getElementById('watchlist-overlay').innerHTML = '';
            document.body.style.overflowY = "scroll";
        }

        function SaveToWatchlist(id, title, poster) {
            var watchlist = localStorage.getItem("Watchlist");
            if (watchlist != null && watchlist != "[]" && watchlist != "") { //check if there is a watchlist
                var data = JSON.parse(watchlist);
                if (!_.find(data, { 'imdbID': id })) {
                    data.push(
                        {
                            'Title': title,
                            'Poster': poster,
                            'imdbID': id,
                        }
                    );
                    localStorage.setItem("Watchlist", JSON.stringify(data));
                }
            }
            else {
                localStorage.setItem("Watchlist", JSON.stringify(
                    [
                        {
                            'Title': title,
                            'Poster': poster,
                            'imdbID': id,
                        }
                    ]
                ));
            }
        }

        function RemoveFromWatchlist(id) {
            var watchlist = localStorage.getItem("Watchlist");
            if (watchlist != null && watchlist != "[]" && watchlist != "") { //check if there is a watchlist
                var data = JSON.parse(watchlist);
                if (_.find(data, { 'imdbID': id })) {
                    data = data.filter(item => item.imdbID !== id);
                    localStorage.setItem("Watchlist", JSON.stringify(data));
                }
            }
        }

        function RemoveElemFromWatchlistUI(elem) {
            let id = elem.getAttribute('data-imdb-id');
            let child = document.getElementById("watchlist-" + id);
            child.parentNode.removeChild(child);
            RemoveFromWatchlist(id);
            var watchlist = localStorage.getItem("Watchlist");
            if (watchlist != null && watchlist != "[]" && watchlist != "") { //check if there is a watchlist
                var list = JSON.parse(watchlist);
                console.log(list);
                if (!_.find(list, { 'imdbID': id })) {
                    document.getElementById('watchlist').classList.remove('is-link');
                    app.showplus = true;
                }
                else {
                    document.getElementById('watchlist').classList.add('is-link');
                    app.showplus = false;
                }
            }
            else {
                document.getElementById('watchlist-overlay-container-backbutton').style.display = 'initial';
                document.getElementById('watchlist-overlay-container').style.display = 'initial';
                document.getElementById('watchlist-overlay-empty-msg').style.display = 'initial';
                document.getElementById('watchlist').classList.remove('is-link');
                app.showplus = true;
            }
        }

        LoadJSON();    
    </script>
</body>

</html>