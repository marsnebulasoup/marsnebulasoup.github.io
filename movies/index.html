<!DOCTYPE html>
<html class="family-primary" id="everything">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- <link href="css/bulma.css" rel="stylesheet"> -->
    <link href="css/bulma_custom/css/mystyles.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300&display=swap" rel="stylesheet">
    <script src="js/ui.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <link href="css/star-rating.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.4.5/fuse.min.js"></script>
    <script src="js/parse_movies.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/cferdinandi/smooth-scroll@15.0.0/dist/smooth-scroll.polyfills.min.js"></script>
    <script type="text/javascript" src="js/jszip/jszip.min.js"></script>
    <script language="javascript" src="js/lz-string/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- <script src="js/lodash/lodash_debounce.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="db/autocomplete.js"></script>
    <script src="db/popularmovies.js"></script>


</head>
<script>
    LoadZippedFile();
    async function getbigfile() {
        popularmoviesjson = await fetch('http://lengthapi.win/movies/db/100kpopularmovies.json')
            .then(res => {
                if (!res.ok) {
                    throw new Error("Failed with HTTP code " + response.status);
                }
                return res.json()
            })
            .catch(err => {
                console.log("Error: " + err);
            })
    }
    getbigfile();

</script>

<body>
    <div class="container is-fluid">
        <div style="padding-top:5%" class="level">
            <div class="level-left" id="type_erase">
                <!-- !!! DO NOT DELETE THIS IS THE TYPING AND ERASING THING !!! IT MOVED TO js/ui.js !!! -->
                <!---->
                <div>
                    <div id="text" style="opacity:100;">
                        <div style="display: inline-block;" id="findtheperfect"></div>
                        <div style="display: inline-block;" id="movie/tvshow"></div>
                    </div>
                    <div id="cursor"></div>
                </div>

                <script>
                    TypeAndErase();
                </script>
            </div>

            <div class="level-right" id="searchbar">
                <p class="control  has-icons-right sticky">
                    <input onclick="TransformSearch(1)" class="input is-rounded search" type="text"
                        placeholder="Search movies...">

                    <span id="bogus-searchbar-icon" class="icon is-small is-right">
                        <i class="fas fa-search"></i>
                    </span>
                </p>
            </div>
        </div>
        <div id="app">
            <div id="overlay-search">
                <div v-show="displaytrailer == false" class="close-overlay-button">
                    <i onclick="TransformSearch()" class="fas fa-arrow-left fa-2x"></i>
                </div>
                <div class="columns is-multiline is-centered overlay-container">
                    <div class="column is-6 sticky">
                        <div id="searchbarcontainer">
                            <ul style="background-color: black;" id="hints-container" class="hints-container">
                                <input v-model="query" v-on:keyup.enter="enter" id="hints-searchbar" type="text"
                                    class="input is-rounded is-large hints-searchbar"
                                    placeholder="Start typing to search movies">
                                <li class="hints-hints-container" id="hints-hints-container">
                                    <div>
                                        <ul class="hints-li">
                                            <li>
                                                <div
                                                    style="padding-left: 1% !important; padding-top: 1%; font-variant: small-caps;">
                                                    {{inputtopcornermsg}}
                                                </div>
                                            </li>
                                            <ul id="hints-hints" class="hints-hints">

                                            </ul>
                                        </ul>
                                    </div>
                                </li>

                            </ul>
                        </div>
                    </div>
                    <div class="column is-10" style="margin-top: 6%;">
                        <p id="nav">{{navbar}}</p>
                    </div>
                    <div v-show="title != ''" class="column is-10">
                        <div class="tile is-ancestor">
                            <div id="overlay" class="tile is-12 overlay">

                                <div class="col" style="width:18%; height:20em;">
                                    <img id="poster" class="poster" v-bind:src="poster" />
                                </div>
                                <div class="col" style="width: 60%">
                                    <div class="outer-container">
                                        <div class="top-section">
                                            <p id="title" style="font-size: 2em;">{{title}}</p>

                                            <p id="plot" style="padding-top:20px;font-size: 1.25em;">
                                                {{plot}}
                                            </p>
                                        </div>
                                        <div class="bottom-section">
                                            <div class="bottom-aligner"></div>
                                            <div class="bottom-content">
                                                <div>
                                                    <p id="info" class="movieinfo" style="font-size: 1.1em">{{year}}
                                                        &middot; {{runtime}} &middot; <span class="boxed">{{age}}</span>
                                                    </p>
                                                    <p class="movieinfo break" style="font-size: 1.1em;">IMDb
                                                        {{rating}} &middot;
                                                        {{genres}}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col" style=" width:20%">
                                    <div class="mainmoviebuttons">
                                        <ul style="width:100%; height:100%;">
                                            <li>
                                                <span>
                                                    <a id="trailer"
                                                        onclick="GetTrailer(overlay.currentmovieid).then(result => overlay.url = result, error => console.log(error)); overlay.displaytrailer = true;"
                                                        class="button is-rounded is-link is-large is-outlined block">
                                                        <i class="fas fa-play"></i>
                                                        &nbsp;
                                                        Play Trailer
                                                    </a>
                                                </span>
                                            </li>
                                            <li>
                                                <span>
                                                    <a id="watchlist"
                                                        class="button is-rounded is-link is-large is-outlined block">
                                                        <i class="fas fa-plus"></i>
                                                        <i style="display: none" class="fas fa-check"></i>
                                                        &nbsp;
                                                        Watchlist
                                                        &nbsp;
                                                    </a>
                                                </span>
                                            </li>
                                            <li>
                                                <span>
                                                    <div class="rating-holder">
                                                        <div id="stars" class="c-rating c-rating--big"
                                                            data-rating-value="1.25">
                                                            <div class="level">
                                                                <div class="level-left">
                                                                    <button>1</button>
                                                                    <button>2</button>
                                                                    <button>3</button>
                                                                    <button>4</button>
                                                                    <button>5</button>
                                                                </div>
                                                                <div class="level-right">
                                                                    <p id="reviewinfo" class="movieinfo"
                                                                        style="font-size: 75%"> &nbsp; 4.9 &middot;
                                                                        (1034)</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                    </div>
                                                </span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div v-if="displaytrailer == true" id="overlay-trailer">
                                    <div v-on:click="displaytrailer = false" class="close-overlay-button">
                                        <i class="fas fa-arrow-left fa-2x"></i>
                                    </div>
                                    <iframe v-if="url != ''" width="1120" height="630" v-bind:src="url" frameborder="0"
                                        allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen></iframe>

                                    <div v-else class="tile is-ancestor"
                                        style="align-items: center; justify-content: center;">
                                        <div class="tile is-parent is-4">
                                            <div class="tile is-child"
                                                style="padding: 15px; background-color: #090979; border-radius: 10px;">
                                                <h1 style="font-size:24pt;">Uh-oh! &nbsp;&nbsp; :-(</h1>
                                                <br>
                                                <p class="subtitle">The trailer for this movie wasn't found.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>

                    </div>

                    <div id="therest" class="column is-10">
                        <div class="tile is-ancestor">
                            <div id="parentMovie" class="tile is-parent is-12" style="flex-wrap: wrap;">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding-top:5%;" class="columns is-multiline is-centered buttons-group">
                <div id="pick" class="column is-12">
                    <div class="moviepicker-container">
                        <p style="font-size: 1.5em; text-align:center;">What do <i><b>you</b></i> want to watch?</p>
                        <!-- <div class="tile is-ancestor"> -->

                        <!-- </div> -->
                    </div>
                </div>

                <div class="column is-4">
                    <!-- TYPE: MOVIE/TV -->
                    <div id="type" class="buttons">

                    </div>

                    <!-- YEAR: 2000s 90s... -->
                    <div id="year" class="buttons">

                    </div>

                    <!-- RATING: HIGHLY RATED, AWARD-WINNING -->
                    <div id="rating" class="buttons ">

                    </div>
                </div>
                <!-- NEXT COLUMN -->
                <div class="column is-8">
                    <!-- GENRE: ACTION, COMEDY... -->
                    <div id="genres" class="buttons ">

                    </div>

                    <div class="buttons">
                        <!-- EMPTY DIV TO ALIGN RATINGS AND AGE -->
                    </div>

                    <!-- AGE RATING: PG-13, TV-14... -->
                    <div id="age" class="buttons">

                    </div>
                </div>

                <div class="column is-12">
                    <div class="dropdown">
                        <div class="dropdown-trigger">
                            <button class="button is-small is-rounded is-primary is-outlined is-hovered">
                                <span>Sort <span style="font-variant: small-caps;">({{sortvalue}})</span></span>
                                <span class="icon is-small">
                                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                                </span>
                            </button>
                        </div>
                        <div class="dropdown-menu" id="dropdown-menu2" role="menu">
                            <div id="dropdowncontent"
                                style="background-color: rgb(9,6,61,1) !important; box-shadow: 2px 2px 20px 1px black !important;"
                                class="dropdown-content">
                                <div onclick="SelectDropdown(this);" class="dropdown-item selected">
                                    <p>Popularity</p>
                                </div>
                                <!-- <hr class="dropdown-divider"> -->
                                <div onclick="SelectDropdown(this);" class="dropdown-item">
                                    <p>Newest</p>
                                </div>
                                <div onclick="SelectDropdown(this);" class="dropdown-item">
                                    <p>Rating - High to Low</p>
                                </div>
                                <div onclick="SelectDropdown(this);" class="dropdown-item">
                                    <p>Rating - Low to High</p>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- <p style="font-variant: small-caps;">no results found</p> -->
                </div>

                <div class="column is-12">

                    <div class="tile is-ancestor">
                        <div id="filteredmovies-container" class="tile is-parent is-12" style="flex-wrap: wrap;">

                        </div>
                    </div>
                </div>

            </div>
        </div>
        <style>
            .dropdown-content p:hover {
                color: gray;
            }
        </style>

    </div>
    <!-- <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br> -->

</body>

<script>

    var overlay = new Vue({
        el: "#app",
        data: {
            title: "",
            poster: "",
            plot: "",
            year: "",
            runtime: "",
            age: "",
            rating: "",
            genres: "",
            navbar: "",
            currentmovieid: "",
            url: "", //trailer url
            displaytrailer: false,
            query: "",
            hints: "", //should delete this; it's not nessesarry. it's for v-html="hints" somewhere
            inputtopcornermsg: "popular movies",
            sortvalue: "popularity",
            currentFocus: -1,
            computed: [[], [], [], [], []],
            filteredmovies: [],
            filteredmovies_sorted_by_popularity: []
        },
        watch: {
            query: _.debounce(function (q) {
                if (!q) {
                    document.getElementById("hints-hints").innerHTML = "";
                    this.inputtopcornermsg = "no results found"
                    return false;
                }
                this.currentFocus = -1;
                computeAutocomplete(q);
            }, 85),

            filteredmovies: _.debounce(function (movies) {
                var childmovie_container = document.getElementById("filteredmovies-container");
                childmovie_container.innerHTML = "";
                if (!isEmpty(movies)) {
                    movies.forEach(movie => {
                        //console.log(movie.Title);
                        // var movie = await fetch('db/ind/' + results[index].imdbID + ".json")
                        //     .then(res => {
                        //         if (!res.ok) {
                        //             throw new Error("Failed with HTTP code " + response.status);
                        //         }
                        //         return res.json()
                        //     })
                        //     .catch(err => {
                        //         console.log("Error: " + err);
                        //     })


                        var imgurl = movie.Poster;
                        if (imgurl == "N/A") {
                            imgurl = "images/unknown.png"
                        }

                        var childMovie = document.createElement("div");
                        childMovie.setAttribute("class", "tile is-child is-2");

                        var smallmovie = document.createElement("div");
                        smallmovie.setAttribute("class", "smallmovie");
                        childMovie.appendChild(smallmovie);

                        var ul = document.createElement("ul");
                        smallmovie.appendChild(ul);

                        var card = document.createElement("div");
                        card.setAttribute("class", "card-home");
                        ul.appendChild(card);

                        var posterLi = document.createElement("li");
                        var titleLi = document.createElement("li");
                        card.appendChild(posterLi);
                        card.appendChild(titleLi);

                        var posterDiv = document.createElement("p");
                        posterDiv.setAttribute("style", "height: 13.5em");
                        posterLi.appendChild(posterDiv);

                        var poster = document.createElement("img");
                        poster.setAttribute("class", "poster-little-home");
                        poster.setAttribute("src", imgurl);
                        posterDiv.appendChild(poster);

                        var title = document.createElement("p");
                        title.setAttribute("class", "caption");
                        title.innerText = movie.Title;
                        titleLi.appendChild(title);

                        childMovie.addEventListener("click", function () {
                            //redirect to somewhere else
                            window.location.href = "http://lengthapi.win/time";
                        })

                        childmovie_container.insertAdjacentElement('beforeend', childMovie);
                    });
                }
                else if(this.computed.every(arr => !arr.length > 0)){
                    childmovie_container.innerHTML = `
                    <div class="tile is-child">
                        <p style="text-align: center;">
                            <span style="font-size: 150%;">Click some buttons to search :)  </span>
                        </p>
                    </div>`
                }
                else {
                    childmovie_container.innerHTML = `
                    <div class="tile is-child">
                        <p style="text-align: center;">
                            <span style="font-size: 150%;">No results found :(</span>
                            <br>
                            <span class="has-text-light" style="font-variant: small-caps;">try doing a less specific search</span>
                        </p>
                    </div>`
                }

            }, 200),

            sortvalue: function () {
                this.sorter();
            }

        },
        methods: {
            enter: function () {
                document.getElementById("hints-searchbar").blur()
                unsetFocused();
                SearchMovies();
            },
            recompute: function () {
                var childmovie_container = document.getElementById("filteredmovies-container");
                var c = this.computed.slice(0);
                // c = [[Type], [Year], [Rating], [Genres], [Age]]
                if (!isEmpty(c)) {
                    childmovie_container.innerHTML = `
                    <div class="tile is-child">
                        <p style="text-align: center;">
                            <span style="font-size: 150%;">Loading...</span>
                        </p>
                    </div>`
                    var movies = popularmoviesjson;
                    var count = 0;
                    this.filteredmovies = [];
                    for (movie of movies) {
                        if (count == 20) {
                            break;
                        }
                        var checks = [];
                        if (c[1].length > 0) { /*check if the year arr is not empty*/
                            var yearcheck = false;
                            for (item of c[1]) {
                                var currentyear = new Date().getFullYear();
                                var rangeStart;
                                switch (item) {
                                    case "Recent":
                                        rangeStart = currentyear - 9;
                                        break;
                                    case "2000s":
                                        rangeStart = 2000;
                                        break;
                                    case "'90s":
                                        rangeStart = 1990;
                                        break;
                                    case "'80s":
                                        rangeStart = 1980;
                                        break;
                                    case "'70s":
                                        rangeStart = 1970;
                                        break;
                                    case "'60s":
                                        rangeStart = 1960;
                                        break;
                                    case "'50s":
                                        rangeStart = 1950;
                                        break;
                                    case "'40s":
                                        rangeStart = 1940;
                                        break;
                                    case "'30s":
                                        rangeStart = 1930;
                                        break;
                                    case "Classic":
                                        rangeStart = 1920;
                                        break;
                                    default:
                                        rangeStart = currentyear - 9;
                                        break;
                                }
                                yearcheck = Number(movie.Year) >= rangeStart && Number(movie.Year) < rangeStart + 10;
                                if (yearcheck) {
                                    break;
                                }
                            }
                            checks.push(yearcheck);
                        }

                        if (c[2].length > 0) { /*check if the rating arr is not empty*/
                            var ratingcheck = false;
                            var highlyrated = Number(movie.imdbRating) >= 7;
                            var awardwinning = movie.Awards != "N/A";

                            if ((c[2].includes("Highly Rated") === true) && (c[2].includes("Award-Winning") === true)) {
                                if (highlyrated && awardwinning) {
                                    ratingcheck = true;
                                }
                            }
                            else if (c[2].includes("Highly Rated")) {
                                ratingcheck = highlyrated;
                            }
                            else if (c[2].includes("Award-Winning")) {
                                ratingcheck = awardwinning;
                            }

                            checks.push(ratingcheck);
                        }

                        if (c[3].length > 0) { /*check if the genre arr is not empty*/
                            var genrecheck = false;
                            var userPreferredGenres = c[3].slice(0); /* eg. ["Action", "Comedy"] */

                            if (c[3].includes("Only")) {
                                var sorted = userPreferredGenres.sort(sortArr);
                                var resorted = _.remove(sorted, item => item != "Only");
                                genrecheck = _.isEqual(resorted, movie.Genre.split(", "));
                            }
                            else {
                                genrecheck = arrayContainsArray(movie.Genre.split(", "), userPreferredGenres);
                            }

                            checks.push(genrecheck);
                        }

                        if (c[4].length > 0) { /*check if the age arr is not empty*/
                            var agecheck = c[4].includes(movie.Rated);
                            checks.push(agecheck);
                        }

                        var finalscore = checks.every((val) => val === true); //makes sure all the options in the filter are true

                        if (finalscore) {
                            this.filteredmovies.push(movie);
                            count++;
                        }
                    }
                    //SelectDropdown()
                    this.filteredmovies_sorted_by_popularity = this.filteredmovies;
                    this.sorter();

                    // forEach(                        node => node.classList.contains("selected"))                      );

                }
                else {
                    console.log("c is empty");
                    this.filteredmovies = [];

                }

            },
            sorter: function () {
                var operation = this.sortvalue;

                if (operation == "popularity") {
                    if(!this.computed.every(arr => !arr.length > 0)){
                        this.filteredmovies = this.filteredmovies_sorted_by_popularity;
                    }
                }
                else if (operation == "newest") {
                    this.filteredmovies = _.orderBy(this.filteredmovies, ['Year'], ['desc']);
                }
                else if (operation == "rating - high to low") {
                    this.filteredmovies = _.orderBy(this.filteredmovies, ['imdbRating'], ['desc']);
                }
                else if (operation == "rating - low to high") {
                    this.filteredmovies = _.orderBy(this.filteredmovies, ['imdbRating'], ['asc']);
                }
            }
        }
    })

    let moviecount = 0;
    let twentypopularmovies = [];
    for (movie of popularmoviesjson) {
        if (moviecount == 20) {
            break;
        }
        twentypopularmovies.push(movie);
        moviecount++;
    }
    overlay.filteredmovies = twentypopularmovies.slice(0);
    Display(twentypopularmovies);
    overlay.navbar = "Popular movies";
    ////////
    let dropdown = document.querySelector('.dropdown');
    dropdown.addEventListener('click', function (event) {
        //event.stopPropagation();
        dropdown.classList.toggle('is-active');
    });

    function SelectDropdown(el) {
        if (!el.classList.contains("selected")) {
            getSiblings(el).forEach(elem => elem.classList.remove("selected"));
            el.classList.add("selected");
            overlay.sortvalue = el.innerText.toLowerCase();
        }
    }
    ///////////////

    document.getElementById("hints-searchbar").addEventListener("keydown", function (e) {
        var x = document.getElementById("hints-hints");
        if (x) x = x.getElementsByTagName("li");
        if (e.keyCode == 40) {
            overlay.currentFocus++;
            addActive(x);
        } else if (e.keyCode == 38) {
            overlay.currentFocus--;
            addActive(x);
        } else if (e.keyCode == 13) {
            e.preventDefault();
            if (overlay.currentFocus > -1) {
                if (x) x[overlay.currentFocus].click();
            }
        }
    });

    var searchbarcontainer = document.getElementById('searchbarcontainer');
    document.addEventListener('click', function (event) {
        var isClickInside = searchbarcontainer.contains(event.target);
        if (isClickInside) {
            //Clicked IN
            setFocused();
        }
        else {
            //Clicked OUT
            unsetFocused();
        }
    });

    displayPopularMovies(); /* Run this for the first time to preload the popular movies into the searchbar */

    //Smooth scroll
    var scroll = new SmoothScroll('a[href*="#"]', {
        speed: 700,
        speedAsDuration: true
    });
    //scroll.destroy();

    //Button generator
    function GenerateButtons() {
        var data = {
            id: ["type", "year", "rating", "genres", "age"],
            content: [
                [
                    "Movie",
                    "TV"
                ],
                [
                    "Recent",
                    "2000s",
                    "'90s",
                    "'80s",
                    "'70s",
                    "'60s",
                    "'50s",
                    "'40s",
                    "'30s",
                    "Classic"
                ],
                [
                    "Highly Rated",
                    "Award-Winning"
                ],
                [
                    "Action",
                    "Adult",
                    "Adventure",
                    "Animation",
                    "Biography",
                    "Comedy",
                    "Crime",
                    "Documentary",
                    "Drama",
                    "Family",
                    "Fantasy",
                    "Film-Noir",
                    "Game-Show",
                    "History",
                    "Horror",
                    "Music",
                    "Musical",
                    "Mystery",
                    "News",
                    "Reality-TV",
                    "Romance",
                    "Sci-Fi",
                    "Sport",
                    "Talk-Show",
                    "Thriller",
                    "War",
                    "Western",
                    "Only"
                ],
                [
                    "G",
                    "PG",
                    "PG-13",
                    "R",
                    "NC-17"
                    // "TV-Y",
                    // "TV-Y7",
                    // "TV-G",
                    // "TV-PG",
                    // "TV-14",
                    // "TV-MA"
                ]
            ]
        }



        for (id of data.id) {
            var currentgroup = document.getElementById(id);
            var catagorytitle = id[0].toUpperCase() + id.slice(1);
            currentgroup.innerHTML = '<button class="button is-static is-rounded" style="border: none;">' + catagorytitle + '</button>';
            for (button of data.content[data.id.indexOf(id)]) {
                var a = document.createElement("a");
                var datacatagoryindex = data.id.indexOf(id).toString();
                a.setAttributeNode(document.createAttribute("data-scroll"));
                a.setAttribute("href", "#pick");
                a.setAttribute("data-catagory-index", datacatagoryindex);
                a.setAttribute("class", "button is-hovered is-rounded is-outlined buttons-group-mod has-text-white");
                a.innerText = button;
                a.addEventListener("click", function (e) {
                    this.blur()
                    var classes = this.classList;
                    var catagory_index = parseInt(this.getAttribute("data-catagory-index"));
                    var totoggle = "buttons-group-mod";
                    var totoggleto = "is-link";
                    if (classes.contains(totoggle)) {
                        //SELECTED
                        classes.remove(totoggle);
                        classes.add(totoggleto)
                        //Adding items to an array is easy. Removing them is not :(
                        overlay.computed[catagory_index].push(this.innerText);
                    }

                    else {
                        //NOT SELECTED
                        classes.remove(totoggleto);
                        classes.add(totoggle)
                        //Quick and easy way to remove an item from an array :)
                        overlay.computed[catagory_index] = overlay.computed[catagory_index].filter(item => item !== this.innerText);
                    }

                    overlay.recompute();
                    // console.log(overlay.computed);
                });
                currentgroup.insertAdjacentElement("beforeend", a);

            }
        }
    }

    GenerateButtons()
</script>

</html>